<!-- Slim Top Bar -->
<header
  class="flex items-center justify-between h-14 px-6 bg-[#0a0a0f] border-b border-zinc-800 flex-shrink-0 z-30"
>
  <!-- Left: Page Title -->
  <div class="flex items-center gap-3 min-w-0">
    <span class="text-[13px] font-semibold text-zinc-200 truncate">{{
      pageTitle
    }}</span>
  </div>

  <!-- Right: Actions -->
  <div class="flex items-center gap-1">
    <!-- Search -->
    <button
      class="flex items-center justify-center w-8 h-8 rounded-lg text-zinc-400 hover:text-white hover:bg-zinc-800 transition-colors"
      title="Search"
    >
      <span class="material-symbols-outlined text-[20px]">search</span>
    </button>

    <!-- Attendance Simulator -->
    <button
      (click)="openSimulator()"
      class="flex items-center justify-center w-8 h-8 rounded-lg text-zinc-400 hover:text-[#a78bfa] hover:bg-zinc-800 transition-colors"
      title="Attendance Simulator"
    >
      <span class="material-symbols-outlined text-[20px]">verified_user</span>
    </button>

    <!-- Notification Bell -->
    <div class="relative">
      <button
        (click)="toggleNotifPanel()"
        class="relative flex items-center justify-center w-8 h-8 rounded-lg text-zinc-400 hover:text-white hover:bg-zinc-800 transition-colors"
        title="Notifications"
      >
        <span class="material-symbols-outlined text-[20px]">notifications</span>
        @if ((unreadCount$ | async) ?? 0; as count) {
          @if (count > 0) {
            <span
              class="absolute top-1 right-1 flex items-center justify-center min-w-[16px] h-[16px] text-[9px] font-bold text-white bg-[#a78bfa] rounded-full px-0.5 leading-none"
            >
              {{ count > 99 ? '99+' : count }}
            </span>
          }
        }
      </button>

      <!-- Notification Dropdown -->
      @if (showNotifPanel) {
        <div
          class="absolute right-0 top-full z-50 mt-2 w-80 bg-[#0a0a0f] border border-zinc-800 rounded-xl shadow-2xl animate-fade-in"
          (click)="$event.stopPropagation()"
        >
          <!-- Header -->
          <div
            class="flex items-center justify-between px-4 py-3 border-b border-zinc-800"
          >
            <span class="text-sm font-semibold text-white">Notifications</span>
            <button
              (click)="onMarkAllRead()"
              class="text-xs text-[#a78bfa] hover:underline"
            >
              Mark all read
            </button>
          </div>

          <!-- List -->
          <div class="overflow-y-auto max-h-72">
            @if (notifications.length === 0) {
              <div class="px-4 py-8 text-center text-zinc-500 text-sm">
                <span class="material-symbols-outlined text-3xl block mb-2 text-zinc-700"
                  >notifications_off</span
                >
                No notifications
              </div>
            }
            @for (notif of notifications; track notif.id) {
              <div
                [ngClass]="{'bg-zinc-900/60': !notif.isRead}"
                class="flex items-start gap-3 px-4 py-3 border-b border-zinc-800/50 hover:bg-zinc-800/40 cursor-default transition-colors"
              >
                <span
                  class="material-symbols-outlined text-base mt-0.5 flex-shrink-0"
                  [class.text-emerald-400]="notif.type === 'LeaveApproved'"
                  [class.text-red-400]="notif.type === 'LeaveRejected'"
                  [class.text-sky-400]="
                    notif.type !== 'LeaveApproved' &&
                    notif.type !== 'LeaveRejected'
                  "
                >
                  {{
                    notif.type === 'LeaveApproved'
                      ? 'check_circle'
                      : notif.type === 'LeaveRejected'
                        ? 'cancel'
                        : 'info'
                  }}
                </span>
                <div class="flex-1 min-w-0">
                  <p class="text-xs font-semibold text-white truncate">
                    {{ notif.title }}
                  </p>
                  <p class="text-xs text-zinc-400 mt-0.5 line-clamp-2">
                    {{ notif.body }}
                  </p>
                  <p class="text-[10px] text-zinc-600 mt-1">
                    {{ notif.createdAt | date: 'short' }}
                  </p>
                </div>
                @if (!notif.isRead) {
                  <button
                    (click)="onMarkRead(notif.id, $event)"
                    class="text-zinc-500 hover:text-white flex-shrink-0 transition-colors"
                    title="Mark as read"
                  >
                    <span class="material-symbols-outlined text-sm">done</span>
                  </button>
                }
              </div>
            }
          </div>

          <!-- Footer -->
          <div class="px-4 py-2 text-center border-t border-zinc-800">
            <button
              (click)="closeNotifPanel()"
              class="text-xs text-zinc-500 hover:text-white transition-colors"
            >
              Close
            </button>
          </div>
        </div>
      }
    </div>

    <!-- Divider -->
    <div class="w-px h-5 bg-zinc-800 mx-1"></div>

    <!-- User Profile -->
    @if (currentUser$ | async; as user) {
      <div class="relative group">
        <div
          class="flex items-center gap-2 pl-2 pr-3 py-1 rounded-full cursor-pointer hover:bg-zinc-800 transition-colors"
        >
          <img
            [src]="user.avatar || ''"
            alt="User"
            class="w-7 h-7 rounded-full object-cover border border-zinc-700 flex-shrink-0"
            onerror="
              this.onerror = null;
              this.src =
                'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjM2YzZjQ2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2E3OGJmYSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPiYjOTc4MTs8L3RleHQ+PC9zdmc+';
            "
          />
          <span class="text-xs font-medium text-zinc-200 max-w-[80px] truncate hidden sm:block">
            {{ user.username }}
          </span>
          <span class="material-symbols-outlined text-zinc-500 text-[16px]">
            expand_more
          </span>
        </div>

        <!-- Profile dropdown -->
        <div
          class="hidden absolute right-0 top-full z-50 pt-1 w-48 transition-all group-hover:block"
        >
          <div
            class="bg-[#0a0a0f] border border-zinc-800 rounded-xl shadow-2xl py-1 animate-fade-in text-left"
          >
            <div class="px-4 py-2.5 border-b border-zinc-800 mb-1">
              <p class="text-xs font-bold text-white truncate">
                {{ user.username }}
              </p>
              <p class="text-[10px] text-zinc-500 truncate">{{ user.email }}</p>
            </div>
            <a
              routerLink="/profile"
              class="flex gap-2.5 items-center px-4 py-2 text-[13px] text-zinc-300 hover:text-white hover:bg-zinc-800 transition-colors"
            >
              <span class="material-symbols-outlined text-[16px]">person</span>
              Profile
            </a>
            <a
              routerLink="/settings"
              class="flex gap-2.5 items-center px-4 py-2 text-[13px] text-zinc-300 hover:text-white hover:bg-zinc-800 transition-colors"
            >
              <span class="material-symbols-outlined text-[16px]">settings</span>
              Settings
            </a>
            <div class="my-1 mx-3 h-px bg-zinc-800"></div>
            <button
              (click)="logout()"
              class="flex gap-2.5 items-center px-4 py-2 w-full text-[13px] text-left text-red-400 hover:text-red-300 hover:bg-zinc-800 transition-colors"
            >
              <span class="material-symbols-outlined text-[16px]">logout</span>
              Logout
            </button>
          </div>
        </div>
      </div>
    } @else {
      <a
        routerLink="/login"
        class="px-4 py-1.5 text-xs font-bold text-white rounded-lg transition-all bg-violet-600 hover:bg-violet-500"
      >
        Login
      </a>
    }
  </div>
</header>

<app-attendance-simulator
  [isVisible]="showSimulator"
  (close)="closeSimulator()"
></app-attendance-simulator>