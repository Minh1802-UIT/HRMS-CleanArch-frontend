server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    # ── Gzip compression ─────────────────────────────────────────────────
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain text/css text/xml text/javascript
        application/json application/javascript application/xml
        application/rss+xml font/woff2 image/svg+xml;

    # ── Security headers (edge server, before Kestrel) ───────────────────
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # ── Proxy API calls to .NET backend ──────────────────────────────────
    # Requires the backend container to be on the same Docker network
    # named "app_backend" (matches docker-compose service name).
    location /api/ {
        proxy_pass         http://app_backend:8080;
        proxy_http_version 1.1;
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        "keep-alive";
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 30s;
        proxy_connect_timeout 5s;
    }

    # ── Proxy /health to backend (Docker HEALTHCHECK for frontend) ───────
    location /health {
        proxy_pass http://app_backend:8080/health;
    }

    # ── Angular SPA routing fallback ─────────────────────────────────────
    # Always serve index.html so client-side routing works on direct URL hits
    location / {
        try_files $uri $uri/ /index.html;
        # HTML files must not be cached (Angular updates the entry point)
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate";
        expires 0;
    }

    # ── Long-lived cache for content-hashed static assets ────────────────
    # Angular's CLI appends a content hash to chunk filenames (e.g. main.abc123.js)
    location ~* \.(js|css|woff2?|ttf|eot|ico|png|jpg|gif|svg|webp)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # ── Simple liveness probe (no backend dependency) ────────────────────
    location /nginx-health {
        access_log  off;
        return 200  'ok';
        add_header  Content-Type text/plain;
    }

    # ── Block hidden files (.git, .env, etc.) ────────────────────────────
    location ~ /\. {
        deny all;
    }
}
